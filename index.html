
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ShiomiX マップ（コメント投稿対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Leaflet（CDN） -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4Qxk8YsgJQvY7sMkS0nPAbQWwZ0p7pSp3geV2nE0XQ="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kLwAwE3vVtYzQWQYVjzUqF6oJgYkGkYFv0Xgc="
    crossorigin=""
  ></script>
  <style>
    :root {
      /* 吹き出しの淡い色（要望に合わせて淡色） */
      --balloon-pink:   #ffd7e5; /* 淡いピンク */
      --balloon-green:  #dff5dc; /* 淡い薄緑 */
      --balloon-blue:   #daf0ff; /* 淡い水色 */
      --balloon-yellow: #fff5cc; /* 淡い黄色 */
      --balloon-gray:   #eeeeee; /* 淡いグレー */
      --balloon-text:   #333;
    }

    body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; margin: 10px; color: #333; }
    h1 { font-size: 1.8em; color: #2e7d32; text-align: center; margin: 6px 0 10px; }
    #map { width: 100%; height: 320px; margin-top: 8px; border-radius: 8px; }
    #post-panel { margin-top: 12px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:10px; }
    textarea { width: 100%; min-height: 68px; font-size: 14px; }
    button { padding: 10px 16px; margin: 5px; background-color: #2e7d32; color: white; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; }
    button:hover { background-color: #1b5e20; }
    #status { color:#666; margin-left:6px; font-size: 0.9em; }
    .small { font-size: 12px; color:#777; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 8px; }
    .row label { font-size: 13px; }

    /* ===== バルーン（吹き出し） =====
       - “点”（dot）が左側、バルーン本体は右側に配置（左端合わせ）
       - 枠線なし（border: none）
       - LINEアイコン等の画像は一切表示しない */
    .balloon-wrap {
      position: relative;
      width: max-content;
      max-width: 240px; /* バルーンの横幅上限 */
      transform: translateX(12px); /* 点の右隣にずらす */
      /* LeafletのDivIconのコンテナとして使う */
    }

    .balloon {
      border: none;                /* 枠なし */
      border-radius: 10px;
      padding: 8px 12px 8px 12px;
      color: var(--balloon-text);
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      font-size: 13px;
      line-height: 1.4;
      backdrop-filter: saturate(1.1);
      /* 色はクラスで切替 */
    }
    .balloon.pink   { background: var(--balloon-pink); }
    .balloon.green  { background: var(--balloon-green); }
    .balloon.blue   { background: var(--balloon-blue); }
    .balloon.yellow { background: var(--balloon-yellow); }
    .balloon.gray   { background: var(--balloon-gray); }

    /* 左側の“点”（▲から点への変更） */
    .dot {
      position: absolute;
      left: -12px; /* バルーン左端から左へ（バルーン左端を点中央に近づける） */
      top: 12px;   /* バルーン縦方向中央付近に調整 */
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #2e7d32; /* 点の色（地図上で見えやすい濃緑） */
      box-shadow: 0 0 0 2px rgba(255,255,255,0.8); /* 地図上で視認性を上げる白縁 */
    }

    /* バルーン内の操作行（削除ボタン & 残り時間） */
    .meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      font-size: 12px;
      color: #555;
    }
    .delete-btn {
      background: #d84343;
      border-radius: 4px;
      font-size: 12px;
      padding: 4px 8px;
    }
    .delete-btn:hover { background: #b93636; }
    .time-left { font-size: 11px; color: #666; }

    /* 投稿フォームの色選択（チェックで色指定・同時選択防止） */
    .color-options {
      display: flex; gap: 8px; flex-wrap: wrap;
      margin-top: 6px;
    }
    .color-options input[type="checkbox"] {
      width: 16px; height: 16px; cursor: pointer;
      vertical-align: middle;
    }
    .color-chip {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 4px 8px; border-radius: 6px; font-size: 12px; border: 1px solid #ccc;
    }
    .chip-pink   { background: var(--balloon-pink); }
    .chip-green  { background: var(--balloon-green); }
    .chip-blue   { background: var(--balloon-blue); }
    .chip-yellow { background: var(--balloon-yellow); }
    .chip-gray   { background: var(--balloon-gray); }
  </style>
</head>
<body>

<h1>ShiomiX マップ</h1>
<div id="map"></div>

<!-- コメント投稿 -->
<div id="post-panel">
  <p>現在地（または地図中心）を使ってコメントを投稿します。</p>
  <textarea id="comment" placeholder="例：混雑少なめ／イベント開始まで10分"></textarea>

  <!-- 色選択（チェックで色指定：同時選択はJSで1色に制限） -->
  <div class="row">
    <span class="small">色を選択（淡色）：</span>
    <div class="color-options" id="colorOptions">
      <label class="color-chip chip-pink">
        <input type="checkbox" name="balloonColor" value="pink" /> ピンク
      </label>
      <label class="color-chip chip-green">
        <input type="checkbox" name="balloonColor" value="green" /> 薄緑
      </label>
      <label class="color-chip chip-blue">
        <input type="checkbox" name="balloonColor" value="blue" /> 水色
      </label>
      <label class="color-chip chip-yellow">
        <input type="checkbox" name="balloonColor" value="yellow" /> 黄色
      </label>
      <label class="color-chip chip-gray">
        <input type="checkbox" name="balloonColor" value="gray" /> グレー
      </label>
    </div>
  </div>

  <!-- 表示時間（1/3/6/12/24時間から選択） -->
  <div class="row">
    <label for="ttl" class="small">表示時間：</label>
    <select id="ttl">
      <option value="1">1時間</option>
      <option value="3">3時間</option>
      <option value="6" selected>6時間</option>
      <option value="12">12時間</option>
      <option value="24">24時間</option>
    </select>
  </div>

  <div>
    <button id="postBtn">コメントを投稿</button>
    <span id="status"></span>
  </div>
  <p class="small">※位置が取得できない場合は地図中心座標で投稿します。</p>
</div>

<!-- （参考）LIFF SDK を使う場合はここに liff.init() 等を記述。アイコンは一切表示しない仕様に変更済み -->

<script>
  // ===== 地図初期化 =====
  const map = L.map('map');
  // デフォルト中心（潮見駅付近）
  const defaultCenter = [35.6568, 139.8286];
  map.setView(defaultCenter, 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // 位置取得
  function getCurrentLatLng() {
    return new Promise((resolve) => {
      if (!navigator.geolocation) return resolve(map.getCenter());
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve([pos.coords.latitude, pos.coords.longitude]),
        ()  => resolve(map.getCenter()),
        { enableHighAccuracy: true, timeout: 5000 }
      );
    });
  }

  // ===== 投稿UI：色はチェックで1色だけ選べるように制御 =====
  const colorOptions = document.getElementById('colorOptions');
  colorOptions.addEventListener('change', (e) => {
    if (e.target.name === 'balloonColor') {
      // 他のチェックを外す（1色限定）
      [...colorOptions.querySelectorAll('input[name="balloonColor"]')].forEach(cb => {
        if (cb !== e.target) cb.checked = false;
      });
    }
  });
  function selectedColor() {
    const checked = colorOptions.querySelector('input[name="balloonColor"]:checked');
    return checked ? checked.value : 'pink'; // 未選択時はピンクを既定
  }

  // ===== コメント管理（削除・TTL） =====
  const comments = new Map(); // id -> { marker, deadline, interval }

  function makeBalloonHTML(text, color, ttlHours, id) {
    // 残り時間の表示用（分更新）
    return `
      <div class="balloon-wrap">
        <div class="dot"></div>
        <div class="balloon ${color}">
          <div>${escapeHTML(text)}</div>
          <div class="meta">
            <button class="delete-btn" data-id="${id}">削除</button>
            <span class="time-left" id="tl-${id}"></span>
          </div>
        </div>
      </div>
    `;
  }

  function escapeHTML(s) {
    return s.replace(/[&<>"']/g, (ch) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  }

  function addComment(latlng, text, color, ttlHours) {
    const id = 'c' + Date.now() + Math.floor(Math.random()*1000);
    const html = makeBalloonHTML(text, color, ttlHours, id);

    // DivIconで“点＋右側バルーン”（左端合わせ）を作る
    const icon = L.divIcon({
      html,
      className: 'balloon-icon', // 既定の影響を避けるダミークラス
      iconSize: null,
      iconAnchor: [0, 16] // “点”のあたりをアンカー基準（左端合わせの再現）
    });
    const marker = L.marker(latlng, { icon }).addTo(map);

    const deadline = Date.now() + ttlHours*60*60*1000;
    // 残り時間の表示更新（1分毎）
    const interval = setInterval(() => updateTimeLeft(id, deadline), 60*1000);
    updateTimeLeft(id, deadline); // 初期表示

    // 削除イベント委譲（バルーン内ボタン）
    marker.on('click', (ev) => {
      const target = ev.originalEvent.target;
      if (target && target.matches('.delete-btn')) {
        const delId = target.getAttribute('data-id');
        removeComment(delId);
        ev.originalEvent.stopPropagation();
      }
    });

    // TTL到達で削除
    const ttlTimer = setTimeout(() => removeComment(id), ttlHours*60*60*1000);

    comments.set(id, { marker, deadline, interval, ttlTimer });
    return id;
  }

  function updateTimeLeft(id, deadline) {
    const el = document.getElementById('tl-' + id);
    if (!el) return;
    const ms = deadline - Date.now();
    if (ms <= 0) {
      el.textContent = '期限切れ';
      return;
    }
    const totalMin = Math.ceil(ms / (60*1000));
    const h = Math.floor(totalMin / 60);
    const m = totalMin % 60;
    el.textContent = h > 0 ? `残り ${h}時間${m}分` : `残り ${m}分`;
  }

  function removeComment(id) {
    const item = comments.get(id);
    if (!item) return;
    map.removeLayer(item.marker);
    clearInterval(item.interval);
    clearTimeout(item.ttlTimer);
    comments.delete(id);
  }

  // ===== 投稿ボタン =====
  const postBtn = document.getElementById('postBtn');
  const status = document.getElementById('status');
  postBtn.addEventListener('click', async () => {
    const text = document.getElementById('comment').value.trim();
    if (!text) {
      status.textContent = 'コメントを入力してください';
      return;
    }
    const ttlHours = parseInt(document.getElementById('ttl').value, 10);
    const color = selectedColor();

    // 現在地 or 地図中心
    const latlng = await getCurrentLatLng();

    const id = addComment(latlng, text, color, ttlHours);
    status.textContent = '投稿しました';
    document.getElementById('comment').value = '';
    // 自動で中心へ移動（任意）
    map.panTo(latlng);
    // 数秒後にステータス消去
    setTimeout(() => status.textContent = '', 2500);
  });

  // ===== 参考：既存コメント復元（サーバー連携時）
  // LIFFやPower Pages経由で保存する場合は、ロード時に addComment() を呼んでください。
</script>

</body>
</html>
