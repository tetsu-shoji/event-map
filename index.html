<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã—ãŠã¿ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; margin: 10px; color: #333; }
  h1 { font-size: 1.6em; color: #2e7d32; text-align: center; margin: 10px 0; }
  #line-warning { text-align: center; background: #fff3cd; color: #856404; padding: 6px; margin-bottom: 8px; border-radius: 6px; font-size: 0.8em; }
  #line-warning a { color:#0078D7; text-decoration: underline; font-size:0.9em; }
  .stamp-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 10px; }
  .stamp-cell { width: 100%; padding-top: 100%; position: relative; background: #fff; border: 2px solid #ccc; border-radius: 50%; }
  .stamp-cell span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7em; font-weight: normal; color: #999; white-space: nowrap; }
  .stamp-mark { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background-color: #2e7d32; color: #fff; display:flex; align-items:center; justify-content:center; font-size: 0.8em; font-weight:bold; }
  .btn-container { text-align: center; margin-bottom: 10px; display:flex; flex-direction:column; align-items:center; gap:8px; }
  #qr-btn { padding: 14px; background-color: #2e7d32; color: white; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; width: 90%; }
  #qr-btn:hover { background-color: #1b5e20; }
  #reset-btn { padding: 8px 12px; background-color:#d9534f; color:white; border:none; border-radius:6px; font-size:0.8em; cursor:pointer; width:40%; }
  #reset-btn:hover { background-color:#c9302c; }
  #complete-screen { display: none; text-align: center; padding: 10px; background: #e8f5e9; border-radius: 8px; font-size: 0.9em; }
  #qr-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; }
  .modal-content { width:320px; height:380px; background:#fff; margin:80px auto; padding:10px; border-radius:8px; text-align:center; display:flex; flex-direction:column; justify-content:space-between; }
  #qr-reader { width:200px; margin:auto; }
  iframe { width:100%; height:280px; border:0; border-radius:8px; }
</style>
</head>
<body>

<!-- ãƒ–ãƒ©ã‚¦ã‚¶æ¡ˆå†… -->
<div id="line-warning">
  LINEã‚¢ãƒ—ãƒªå†…ã§ã¯ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ãã¾ã›ã‚“ã€‚<br>
  <a href="https://tetsu-shoji.github.io/event-map/" target="_blank">å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã</a> ã¾ãŸã¯ URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Safari/Chromeã§é–‹ã„ã¦ãã ã•ã„ã€‚
</div>

<h1>ã—ãŠã¿ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h1>

<!-- ã‚¹ã‚¿ãƒ³ãƒ— -->
<div class="stamp-container" id="stampContainer"></div>

<div class="btn-container">
  <button id="qr-btn" onclick="openModal()">QRèª­ã¿è¾¼ã¿é–‹å§‹</button>
  <button id="reset-btn">å…¨å‰Šé™¤</button>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="qr-modal">
  <div class="modal-content">
    <h3>QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</h3>
    <div id="qr-reader"></div>
    <button onclick="closeModal()" style="background-color:#d9534f;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div id="complete-screen">
  <h2>ğŸ‰ ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ ğŸ‰</h2>
  <p>å—ä»˜ã§æ™¯å“ã‚’å—ã‘å–ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
  <a href="https://forms.office.com/r/sn3wvtS6Yy" target="_blank">å¿œå‹Ÿãƒ•ã‚©ãƒ¼ãƒ ã¸</a>
  <p>â€»é€ä¿¡å¾Œã€ã“ã®ç”»é¢ã‚’å—ä»˜ã§æç¤ºã—ã¦ãã ã•ã„ã€‚</p>
</div>

<!-- Googleãƒãƒƒãƒ— -->
<div style="margin-top:10px;">
  <iframe src="https://www.google.com/maps/d/embed?mid=1QOBKw3gOBtzKEe3Rhy6D7VqRLc-FrMQ&ehbc=2E312F" loading="lazy"></iframe>
</div>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<!-- QRã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
  const savedStamps = JSON.parse(localStorage.getItem('stamps')) || [];
  const container = document.getElementById('stampContainer');

  for (let i = 1; i <= 9; i++) {
    const cell = document.createElement('div');
    cell.className = 'stamp-cell';
    const label = document.createElement('span');
    label.textContent = 'ã‚¹ã‚¿ãƒ³ãƒ—' + i;
    cell.appendChild(label);
    if (savedStamps.includes('stamp' + i)) {
      const stamp = document.createElement('div');
      stamp.className = 'stamp-mark';
      stamp.textContent = 'ã‚¹ã‚¿ãƒ³ãƒ—' + i;
      cell.appendChild(stamp);
    }
    container.appendChild(cell);
  }

  let qrReader;

  async function openModal() {
    document.getElementById('qr-modal').style.display = 'block';
    if (!qrReader) qrReader = new Html5Qrcode("qr-reader");
    try {
      await qrReader.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 180 },
        qrCodeMessage => {
          if (/^stamp[1-9]$/.test(qrCodeMessage)) {
            const index = parseInt(qrCodeMessage.replace('stamp',''));
            const cells = document.querySelectorAll('.stamp-cell');
            cells.forEach(cell => {
              if (cell.textContent.includes('ã‚¹ã‚¿ãƒ³ãƒ—' + index) && !cell.querySelector('.stamp-mark')) {
                const stamp = document.createElement('div');
                stamp.className = 'stamp-mark';
                stamp.textContent = 'ã‚¹ã‚¿ãƒ³ãƒ—' + index;
                cell.appendChild(stamp);
                savedStamps.push('stamp' + index);
                localStorage.setItem('stamps', JSON.stringify(savedStamps));
              }
            });
            checkCompletion();
            closeModal();
          }
        },
        errorMessage => console.warn(`èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: ${errorMessage}`)
      );
    } catch (err) {
      alert('ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + err);
    }
  }

  async function closeModal() {
    document.getElementById('qr-modal').style.display = 'none';
    if (qrReader) await qrReader.stop();
  }

  document.getElementById('reset-btn').addEventListener('click', () => {
    if (confirm('æœ¬å½“ã«å…¨ã¦ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      localStorage.removeItem('stamps');
      alert('ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å…¨å‰Šé™¤ã—ã¾ã—ãŸ');
      location.reload();
    }
  });

  function checkCompletion() {
    if (savedStamps.length === 9) {
      document.getElementById('complete-screen').style.display = 'block';
      if (qrReader) qrReader.stop();
    }
  }
  checkCompletion();
</script>
</body>
</html>
