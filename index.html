<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ShiomiXãƒ“ãƒ³ã‚´</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #e6f2ff;
    margin: 0;
    padding: 0;
    color: #333;
  }
  .map-container {
    width: 100%;
    height: 45vh;
    margin-bottom: 10px;
  }
  iframe {
    width: 100%;
    height: 100%;
    border: 0;
    border-radius: 8px;
  }
  .stamp-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    justify-items: center;
    padding: 16px;
  }
  .stamp-cell {
    width: 80px;
    height: 80px;
    position: relative;
    background: #fff;
    border: 3px solid #3399ff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8em;
    color: #3399ff;
    font-weight: bold;
    overflow: hidden;
  }
  .stamp-mark img {
    width: 70%;
    height: auto;
    border-radius: 50%;
    animation: bounce 0.6s ease;
  }
  @keyframes bounce {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); }
  }
  .btn-container {
    text-align: center;
    padding: 16px;
  }
  #qr-btn {
    padding: 14px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 1em;
    cursor: pointer;
    width: 90%;
    margin-bottom: 12px;
  }
  #qr-btn:hover {
    background-color: #0056b3;
  }
  #reset-btn {
    padding: 10px 16px;
    background-color:#3399ff;
    color:white;
    border:none;
    border-radius:6px;
    font-size:0.9em;
    cursor:pointer;
    width:40%;
  }
  #reset-btn:hover {
    background-color:#007bff;
  }
  #qr-modal {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.5);
    z-index:999;
    align-items:center;
    justify-content:center;
  }
  .modal-content {
    width:300px;
    height:360px;
    background:#fff;
    margin:auto;
    padding:10px;
    border-radius:8px;
    text-align:center;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  #qr-reader {
    width:180px;
    margin:auto;
  }
  #complete-screen {
    display:none;
    text-align:center;
    padding:16px;
    background:#cce5ff;
    border-radius:8px;
    margin:16px;
    font-size:1em;
    color:#004085;
    font-weight:bold;
  }
  #form-btn {
    padding: 12px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 1em;
    cursor: pointer;
    margin-top: 10px;
  }
  #form-btn:hover {
    background-color: #0056b3;
  }
  #fireworks {
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    pointer-events:none;
    z-index:9999;
    display:none;
  }
  .confetti {
    position: absolute;
    width: 10px;
    height: 10px;
    background-color: #ffcc00;
    animation: fall 2s linear infinite;
  }
  @keyframes fall {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(500px); opacity: 0; }
  }
</style>
</head>
<body>

<!-- Googleãƒãƒƒãƒ— -->
<div class="map-container">
  <iframe src="https://www.google.com/maps/d/embed?mid=1QOBKw3gOBtzKEe3Rhy6D7VqRLc-FrMQ&ehbc=2E312F" loading="lazy"></iframe>
</div>

<!-- ã‚¹ã‚¿ãƒ³ãƒ— -->
<div class="stamp-container" id="stampContainer"></div>

<!-- ãƒœã‚¿ãƒ³ -->
<div class="btn-container">
  <button id="qr-btn" onclick="openModal()">QRèª­ã¿è¾¼ã¿é–‹å§‹</button><br>
  <button id="reset-btn">å…¨å‰Šé™¤</button>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="qr-modal">
  <div class="modal-content">
    <h3>QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</h3>
    <div id="qr-reader"></div>
    <button onclick="closeModal()" style="background-color:#007bff;color:white;padding:10px;border:none;border-radius:6px;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- å®Œäº†ç”»é¢ -->
<div id="complete-screen">
  <h2>ğŸ‰ ãƒ“ãƒ³ã‚´é”æˆï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ ğŸ‰</h2>
  <p>å—ä»˜ã§æ™¯å“ã‚’å—ã‘å–ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
  <button id="form-btn" onclick="window.open('https://forms.office.com/r/sn3wvtS6Yy','_blank')">å¿œå‹Ÿãƒ•ã‚©ãƒ¼ãƒ ã¸</button>
  <p>â€»é€ä¿¡å¾Œã€ã“ã®ç”»é¢ã‚’å—ä»˜ã§æç¤ºã—ã¦ãã ã•ã„ã€‚</p>
</div>

<!-- èŠ±ç«Canvas -->
<canvas id="fireworks"></canvas>

<!-- éŸ³å£°ï¼ˆã‚¯ãƒ©ãƒƒã‚«ãƒ¼éŸ³ï¼‰ -->
<audio id="fanfare" src="https://www.soundjay.com/button/sounds/button-09.mp3" preload="auto"></audio>

<!-- QRã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const savedStamps = JSON.parse(localStorage.getItem('stamps')) || [];
  const container = document.getElementById('stampContainer');
  const stampImages = [
    'https://cdn-icons-png.flaticon.com/512/616/616408.png', // çŠ¬
    'https://cdn-icons-png.flaticon.com/512/616/616430.png', // çŒ«
    'https://cdn-icons-png.flaticon.com/512/616/616554.png', // è»Š
    'https://cdn-icons-png.flaticon.com/512/616/616485.png', // é³¥
    'https://cdn-icons-png.flaticon.com/512/616/616490.png', // é­š
    'https://cdn-icons-png.flaticon.com/512/616/616495.png', // ãƒã‚¹
    'https://cdn-icons-png.flaticon.com/512/616/616500.png', // é£›è¡Œæ©Ÿ
    'https://cdn-icons-png.flaticon.com/512/616/616505.png', // ã†ã•ã
    'https://cdn-icons-png.flaticon.com/512/616/616510.png'  // ãã¾
  ];

  for (let i = 1; i <= 9; i++) {
    const cell = document.createElement('div');
    cell.className = 'stamp-cell';
    const label = document.createElement('span');
    label.textContent = 'ã‚¹ã‚¿ãƒ³ãƒ—' + i;
    cell.appendChild(label);
    if (savedStamps.includes('stamp' + i)) {
      const stamp = document.createElement('div');
      stamp.className = 'stamp-mark';
      const img = document.createElement('img');
      img.src = stampImages[i-1];
      stamp.appendChild(img);
      cell.appendChild(stamp);
    }
    container.appendChild(cell);
  }
});

let qrReader;

async function openModal() {
  document.getElementById('qr-modal').style.display = 'flex';
  if (qrReader) {
    await qrReader.stop();
    await qrReader.clear();
    qrReader = null;
  }
  qrReader = new Html5Qrcode("qr-reader");
  try {
    await qrReader.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 160 },
      qrCodeMessage => {
        if (/^stamp[1-9]$/.test(qrCodeMessage)) {
          const index = parseInt(qrCodeMessage.replace('stamp',''));
          const cells = document.querySelectorAll('.stamp-cell');
          cells.forEach((cell, idx) => {
            if (idx === index-1 && !cell.querySelector('.stamp-mark')) {
              const stamp = document.createElement('div');
              stamp.className = 'stamp-mark';
              const img = document.createElement('img');
              img.src = [
                'https://cdn-icons-png.flaticon.com/512/616/616408.png',
                'https://cdn-icons-png.flaticon.com/512/616/616430.png',
                'https://cdn-icons-png.flaticon.com/512/616/616554.png',
                'https://cdn-icons-png.flaticon.com/512/616/616485.png',
                'https://cdn-icons-png.flaticon.com/512/616/616490.png',
                'https://cdn-icons-png.flaticon.com/512/616/616495.png',
                'https://cdn-icons-png.flaticon.com/512/616/616500.png',
                'https://cdn-icons-png.flaticon.com/512/616/616505.png',
                'https://cdn-icons-png.flaticon.com/512/616/616510.png'
              ][index-1];
              stamp.appendChild(img);
              cell.appendChild(stamp);
              const savedStamps = JSON.parse(localStorage.getItem('stamps')) || [];
              savedStamps.push('stamp' + index);
              localStorage.setItem('stamps', JSON.stringify(savedStamps));
            }
          });
          checkBingo();
          closeModal();
        }
      }
    );
  } catch (err) {
    alert('ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + err);
  }
}

async function closeModal() {
  document.getElementById('qr-modal').style.display = 'none';
  if (qrReader) {
    await qrReader.stop();
    await qrReader.clear();
    qrReader = null;
  }
}

document.getElementById('reset-btn').addEventListener('click', () => {
  if (confirm('æœ¬å½“ã«å…¨ã¦ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    localStorage.removeItem('stamps');
    alert('ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å…¨å‰Šé™¤ã—ã¾ã—ãŸ');
    location.reload();
  }
});

function checkBingo() {
  const savedStamps = JSON.parse(localStorage.getItem('stamps')) || [];
  const bingoPatterns = [
    [1,2,3],[4,5,6],[7,8,9],
    [1,4,7],[2,5,8],[3,6,9],
    [1,5,9],[3,5,7]
  ];
  for (let pattern of bingoPatterns) {
    if (pattern.every(num => savedStamps.includes('stamp' + num))) {
      document.getElementById('complete-screen').style.display = 'block';
      document.getElementById('complete-screen').scrollIntoView({ behavior: 'smooth' });
      launchConfetti();
      playFanfare();
      break;
    }
  }
}

function launchConfetti() {
  const canvas = document.getElementById('fireworks');
  canvas.style.display = 'block';
  const colors = ['#ffcc00','#ff6666','#66ccff','#66ff66'];
  for (let i = 0; i < 100; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
    confetti.style.left = Math.random()*window.innerWidth + 'px';
    confetti.style.top = '-10px';
    confetti.style.animationeout(() => confetti.remove(), 3000);
  }
}

function playFanfare() {
  document.getElementById('fanfare').play();
}
</script>
</body>
</html>
