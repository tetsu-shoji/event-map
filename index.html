<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ShiomiXãƒ“ãƒ³ã‚´</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 0;
    color: #333;
  }
  .map-container {
    width: 100%;
    height: 45vh;
  }
  iframe {
    width: 100%;
    height: 100%;
    border: 0;
    border-radius: 8px;
  }
  .stamp-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    justify-items: center;
    padding: 8px;
  }
  .stamp-cell {
    width: 70px;
    height: 70px;
    position: relative;
    background: #fff;
    border: 2px solid #ccc;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7em;
    color: #999;
    white-space: nowrap;
  }
  .stamp-mark {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    border-radius: 50%;
    background-color: #2e7d32;
    color: #fff;
    display:flex; align-items:center; justify-content:center;
    font-size: 0.8em; font-weight:bold;
    animation: bounce 0.6s ease;
  }
  @keyframes bounce {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); }
  }
  .btn-container {
    text-align: center;
    padding: 8px;
  }
  #qr-btn {
    padding: 14px;
    background-color: #2e7d32;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 1em;
    cursor: pointer;
    width: 90%;
    margin-bottom: 8px;
  }
  #qr-btn:hover {
    background-color: #1b5e20;
  }
  #reset-btn {
    padding: 6px 10px;
    background-color:#d9534f;
    color:white;
    border:none;
    border-radius:6px;
    font-size:0.8em;
    cursor:pointer;
    width:40%;
  }
  #reset-btn:hover {
    background-color:#c9302c;
  }
  #complete-screen {
    display: none;
    text-align: center;
    padding: 10px;
    background: #e8f5e9;
    border-radius: 8px;
    font-size: 0.9em;
    margin: 8px;
    position: relative;
    z-index: 1000;
  }
  #form-btn {
    padding: 12px 20px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 1em;
    cursor: pointer;
    margin-top: 10px;
  }
  #form-btn:hover {
    background-color: #0056b3;
  }
  #qr-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.4s ease;
  }
  #qr-modal.show {
    display: flex;
    opacity: 1;
  }
  .modal-content {
    width: 90%;
    max-width: 320px;
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  #qr-reader {
    width: 100%;
    max-width: 250px;
    margin: auto;
  }
  #fireworks {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9999;
    display: none;
  }
</style>
</head>
<body>

<!-- Googleãƒãƒƒãƒ— -->
<div class="map-container">
  <iframe src="https://www.google.com/maps/d/embed?mid=1QOBKw3gOBtzKEe3Rhy6D7VqRLc-FrMQ&ehbc=2E312F" loading="lazy"></iframe>
</div>

<!-- ã‚¹ã‚¿ãƒ³ãƒ— -->
<div class="stamp-container" id="stampContainer"></div>

<!-- ãƒœã‚¿ãƒ³ -->
<div class="btn-container">
  <button id="qr-btn" onclick="openModal()">QRèª­ã¿è¾¼ã¿é–‹å§‹</button><br>
  <button id="reset-btn">å…¨å‰Šé™¤</button>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="qr-modal">
  <div class="modal-content">
    <h3>QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</h3>
    <div id="qr-reader"></div>
    <button onclick="closeModal()" style="background-color:#d9534f;color:white;padding:10px;border:none;border-radius:6px;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- å®Œäº†ç”»é¢ -->
<div id="complete-screen">
  <h2>ğŸ‰ ãƒ“ãƒ³ã‚´é”æˆï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ ğŸ‰</h2>
  <p>å—ä»˜ã§æ™¯å“ã‚’å—ã‘å–ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
  <button id="form-btn" onclick="window.open('https://forms.office.com/r/sn3wvtS6Yy','_blank')">å¿œå‹Ÿãƒ•ã‚©ãƒ¼ãƒ ã¸</button>
  <p>â€»é€ä¿¡å¾Œã€ã“ã®ç”»é¢ã‚’å—ä»˜ã§æç¤ºã—ã¦ãã ã•ã„ã€‚</p>
</div>

<!-- èŠ±ç«Canvas -->
<canvas id="fireworks"></canvas>

<!-- QRã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
  const savedStamps = JSON.parse(localStorage.getItem('stamps')) || [];
  const container = document.getElementById('stampContainer');

  // ã‚¹ã‚¿ãƒ³ãƒ—ã‚’3Ã—3ã§è¡¨ç¤º
  for (let i = 1; i <= 9; i++) {
    const cell = document.createElement('div');
    cell.className = 'stamp-cell';
    const label = document.createElement('span');
    label.textContent = 'ã‚¹ã‚¿ãƒ³ãƒ—' + i;
    cell.appendChild(label);
    if (savedStamps.includes('stamp' + i)) {
      const stamp = document.createElement('div');
      stamp.className = 'stamp-mark';
      stamp.textContent = 'ã‚¹ã‚¿ãƒ³ãƒ—' + i;
      cell.appendChild(stamp);
    }
    container.appendChild(cell);
  }

  let qrReader;

  async function openModal() {
    const modal = document.getElementById('qr-modal');
    modal.classList.add('show');

    // å‰å›ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒæ®‹ã£ã¦ã„ã‚Œã°å®Œå…¨è§£æ”¾
    if (qrReader) {
      try {
        await qrReader.stop();
        await qrReader.clear();
      } catch (e) {
        console.warn("å‰å›ã®QRãƒªãƒ¼ãƒ€ãƒ¼è§£æ”¾æ™‚ã‚¨ãƒ©ãƒ¼:", e);
      }
      qrReader = null;
    }

    qrReader = new Html5Qrcode("qr-reader");
    try {
      await qrReader.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 160 },
        qrCodeMessage => {
          if (/^stamp[1-9]$/.test(qrCodeMessage)) {
            const index = parseInt(qrCodeMessage.replace('stamp',''));
            const cells = document.querySelectorAll('.stamp-cell');
            cells.forEach(cell => {
              if (cell.textContent.includes('ã‚¹ã‚¿ãƒ³ãƒ—' + index) && !cell.querySelector('.stamp-mark')) {
                const stamp = document.createElement('div');
                stamp.className = 'stamp-mark';
                stamp.textContent = 'ã‚¹ã‚¿ãƒ³ãƒ—' + index;
                cell.appendChild(stamp);
                savedStamps.push('stamp' + index);
                localStorage.setItem('stamps', JSON.stringify(savedStamps));
              }
            });
            checkBingo();
            closeModal();
          }
        },
        errorMessage => console.warn(`èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: ${errorMessage}`)
      );
    } catch (err) {
      alert('ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: ' + err);
    }
  }

  async function closeModal() {
    const modal = document.getElementById('qr-modal');
    modal.style.opacity = '0';
    setTimeout(() => {
      modal.classList.remove('show');
      modal.style.opacity = '';
      modal.style.display = 'none';
    }, 400);

    if (qrReader) {
      try {
        await qrReader.stop();
        await qrReader.clear();
      } catch (e) {
        console.warn("QRãƒªãƒ¼ãƒ€ãƒ¼åœæ­¢æ™‚ã‚¨ãƒ©ãƒ¼:", e);
      }
      qrReader = null;
    }
  }

  document.getElementById('reset-btn').addEventListener('click', () => {
    if (confirm('æœ¬å½“ã«å…¨ã¦ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      localStorage.removeItem('stamps');
      alert('ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å…¨å‰Šé™¤ã—ã¾ã—ãŸ');
      location.reload();
    }
  });

  function checkBingo() {
    const bingoPatterns = [
      [1,2,3],[4,5,6],[7,8,9],
      [1,4,7],[2,5,8],[3,6,9],
      [1,5,9],[3,5,7]
    ];
    for (let pattern of bingoPatterns) {
      if (pattern.every(num => savedStamps.includes('stamp' + num))) {
        document.getElementById('complete-screen').style.display = 'block';
        launchFireworks();
        document.getElementById('complete-screen').scrollIntoView({ behavior: 'smooth' });
        if (qrReader) {
          try {
            await qrReader.stop();
            await qrReader.clear();
          } catch (e) {
            console.warn("QRãƒªãƒ¼ãƒ€ãƒ¼åœæ­¢æ™‚ã‚¨ãƒ©ãƒ¼:", e);
          }
          qrReader = null;
        }
        break;
      }
    }
  }
  checkBingo();

  function launchFireworks() {
    const canvas = document.getElementById('fireworks');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    canvas.style.display = 'block';

    const particles = [];
    function createFirework(x, y) {
      for (let i = 0; i < 100; i++) {
        particles.push({
          x: x,
          y: y,
          angle: Math.random() * 2 * Math.PI,
          speed: Math.random() * 5 + 2,
          radius: Math.random() * 2 + 1,
          color: `hsl(${Math.random() * 360}, 100%, 50%)`,
          life: 100
        });
      }
    }

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach((p, i) => {
        p.x += Math.cos(p.angle) * p.speed;
        p.y += Math.sin(p.angle) * p.speed;
        p.life--;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
        ctx.fillStyle = p.color;
        ctx.fill();
        if (p.life <= 0) particles.splice(i, 1);
      });
      if (particles.length > 0) requestAnimationFrame(animate);
    }

    for (let i = 0; i < 5; i++) {
      createFirework(Math.random() * canvas.width, Math.random() * canvas.height);
    }
    animate();

    setTimeout(() => {
      canvas.style.display = 'none';
    }, 5000);
  }
</script>
</body>
</html>
