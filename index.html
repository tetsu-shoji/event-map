
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ShiomiX イベントマップ（コメント投稿＋期間／削除）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; margin: 10px; color: #333; }
    h1 { font-size: 1.8em; color: #2e7d32; text-align: center; }
    #map { width: 100%; height: 300px; margin-top: 20px; border-radius: 8px; }
    #post-panel { margin-top: 12px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:10px; }
    textarea { width: 100%; min-height: 60px; font-size: 14px; }
    button { padding: 10px 16px; margin: 5px; background-color: #2e7d32; color: white; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; }
    button:hover { background-color: #1b5e20; }
    #status { color:#666; margin-left:6px; font-size: 0.9em; }
    .small { font-size: 12px; color:#777; }
    .row { display:flex; gap:8px; align-items: center; flex-wrap: wrap; }
    input[type="datetime-local"] { padding:6px; font-size:14px; }
    select { padding:6px; font-size:14px; }
    .danger { background:#c62828; }
    .danger:hover { background:#8e0000; }
  </style>
</head>
<body>

<h1>ShiomiX イベントマップ</h1>
<div id="map"></div>

<!-- 投稿パネル -->
<div id="post-panel">
  <p>現在地（または地図中心）を使ってコメントを投稿します。</p>
  <textarea id="comment" placeholder="例：混雑少なめ／イベント開始まで10分"></textarea>

  <!-- 変更点: 表示期間の入力 -->
  <div class="row">
    <label for="startAt">開始：</label>
    <input type="datetime-local" id="startAt">
    <label for="endAt">終了：</label>
    <input type="datetime-local" id="endAt">
    <!-- 便利プリセット -->
    <select id="preset">
      <option value="">プリセット（任意）</option>
      <option value="30m">30分</option>
      <option value="1h">1時間</option>
      <option value="2h">2時間</option>
      <option value="today">今日いっぱい</option>
    </select>
  </div>

  <div class="row">
    <button id="postBtn">コメントを投稿</button>
    <span id="status"></span>
  </div>
  <p class="small">※位置が取得できない場合は地図中心座標で投稿します。</p>
</div>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<script>
/** 設定 **/
const CONFIG = {
  LIFF_ID: "2008298139-lwyMjbwP",
  APPS_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbyFIrGTYWNhTw7I0u5zK-uPDrzGxH_7xXUxbS-ptxoWBWJTPeE-lu6QLSN5jt35xSc/exec",
  TTL_HOURS_TO_LOAD: 24
};

let map;
const markersById = new Map(); // 変更点: id→marker 管理

// HTMLエスケープ
const esc = s => String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

// ---- LIFF初期化 ----
let liffReady = (async function(){
  try {
    await liff.init({ liffId: CONFIG.LIFF_ID });
    if (!liff.isLoggedIn()) liff.login();
  } catch (e) {
    console.warn('LIFF init error:', e);
  }
})();
async function ensureLiff(){ try { await liffReady; } catch(e) {} }

async function initMap() {
  const center = { lat: 35.659466436461635, lng: 139.8171347921082 }; // 潮見高架下
  map = new google.maps.Map(document.getElementById("map"), { zoom: 18, center });
  await loadPosts();
}

function setStatus(msg){ document.getElementById('status').textContent = msg || ''; }

// 位置取得（失敗時は地図中心）
async function getCurrentLatLng(){
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) return reject(new Error('no geolocation'));
    navigator.geolocation.getCurrentPosition(
      p => resolve({ lat: p.coords.latitude, lng: p.coords.longitude }),
      err => reject(err),
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });
}

// ---- GET（期間内のみ返す） ----
async function loadPosts(){
  setStatus('読み込み中…');
  try {
    const res = await fetch(`${CONFIG.APPS_SCRIPT_URL}?ttlHours=${CONFIG.TTL_HOURS_TO_LOAD}`);
    const raw = await res.text();
    let json;
    try { json = JSON.parse(raw); } catch(e){ throw new Error('JSON parse error: '+e+' / raw='+raw); }
    if (!json.ok) throw new Error(json.error || 'failed');

    // 変更点: 既存マーカーをクリア（簡易）
    for (const m of markersById.values()) m.setMap(null);
    markersById.clear();

    // 返却は期間内のみのはずだが、念のためクライアント側でもフィルタ
    const now = Date.now();
    json.data
      .filter(p => (!p.startAt || new Date(p.startAt).getTime() <= now) &&
                   (!p.endAt   || new Date(p.endAt).getTime()   >= now) &&
                   !p.deletedAt)
      .forEach(addMarker);
    setStatus(`読み込み完了（${json.data.length}件）`);
  } catch (e) {
    console.error('loadPosts error:', e);
    setStatus('読み込み失敗');
  }
}

/** ===== 吹き出しアイコン生成（前回の関数を使用） =====
 * ※ makeSpeechBubbleSVG / measureLines は前回ご提供のものをそのまま利用してください
 *   （ここでは簡潔化のため省略。前回コードからコピペでOK）
 */
// --- 省略: measureLines / makeSpeechBubbleSVG をここに貼り付け ---

function addMarker(p){
  const position = { lat: p.lat, lng: p.lng };
  const avatarUrl = p.avatarUrl || null;
  const { url, totalW, totalH, anchorX, anchorY } = makeSpeechBubbleSVG(p.comment || '', avatarUrl);

  const marker = new google.maps.Marker({
    position, map,
    icon: { url, scaledSize: new google.maps.Size(totalW, totalH), anchor: new google.maps.Point(anchorX, anchorY) }
  });

  // 変更点: クリックで詳細＋削除ボタン（投稿者のみ）
  const canDelete = (p.currentUserId && p.userId && p.currentUserId === p.userId);
  const html = `
    <div>
      <div><b>${esc(p.comment || '')}</b></div>
      ${p.startAt || p.endAt ? `
        <div class="small">
          表示期間：${p.startAt ? new Date(p.startAt).toLocaleString() : '（指定なし）'} 〜
          ${p.endAt ? new Date(p.endAt).toLocaleString() : '（指定なし）'}
        </div>` : ''
      }
      <div class="small">${p.timestamp ? new Date(p.timestamp).toLocaleString() : ''}</div>
      ${canDelete ? `<div style="margin-top:6px;">
        <button class="danger" id="delbtn-${p.id}">この投稿を削除</button>
      </div>` : ''}
    </div>`;

  const info = new google.maps.InfoWindow({ content: html });
  marker.addListener('click', () => {
    info.open({ anchor: marker, map });
    if (canDelete) {
      // イベントを動的に紐付け
      google.maps.event.addListenerOnce(info, 'domready', () => {
        const btn = document.getElementById(`delbtn-${p.id}`);
        if (btn) btn.onclick = () => deletePost(p.id, p.userId);
      });
    }
  });

  if (p.id) markersById.set(p.id, marker);
}

// ---- 投稿（期間・削除対応） ----
document.getElementById('postBtn').addEventListener('click', onPost);
document.getElementById('preset').addEventListener('change', onPresetChange);

// プリセット選択で endAt を自動入力
function onPresetChange(){
  const preset = document.getElementById('preset').value;
  const startEl = document.getElementById('startAt');
  const endEl = document.getElementById('endAt');
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  const toLocal = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  // start は未指定なら now
  if (!startEl.value) startEl.value = toLocal(now);

  if (preset === '30m'){
    const e = new Date(now.getTime() + 30*60*1000);
    endEl.value = toLocal(e);
  } else if (preset === '1h'){
    const e = new Date(now.getTime() + 60*60*1000);
    endEl.value = toLocal(e);
  } else if (preset === '2h'){
    const e = new Date(now.getTime() + 2*60*60*1000);
    endEl.value = toLocal(e);
  } else if (preset === 'today'){
    const e = new Date();
    e.setHours(23,59,0,0);
    endEl.value = toLocal(e);
  }
}

async function onPost(){
  await ensureLiff();

  const commentEl = document.getElementById('comment');
  const startEl = document.getElementById('startAt');
  const endEl = document.getElementById('endAt');

  const comment = commentEl.value.trim();
  if (!comment) return alert('コメントを入力してください');

  // 期間バリデーション
  let startAt = startEl.value ? new Date(startEl.value) : null;
  let endAt   = endEl.value ? new Date(endEl.value) : null;
  if (startAt && endAt && endAt.getTime() < startAt.getTime()){
    return alert('終了時刻は開始時刻以降を指定してください');
  }

  setStatus('投稿中…');

  // ユーザー識別
  let userId = 'guest';
  let avatarUrl = null;
  try {
    const profile = await liff.getProfile();
    if (profile && profile.userId) userId = profile.userId;
    if (profile && profile.pictureUrl) avatarUrl = profile.pictureUrl;
  } catch(e) {
    console.warn('getProfile error:', e);
  }

  // 位置
  let pos;
  try { pos = await getCurrentLatLng(); } catch(e) { pos = map.getCenter().toJSON(); }

  const payload = {
    action: 'create', // 変更点: 明示的アクション
    userId, lat: pos.lat, lng: pos.lng, comment, avatarUrl,
    startAt: startAt ? startAt.toISOString() : null,
    endAt: endAt ? endAt.toISOString() : null
  };

  try {
    let res = await fetch(CONFIG.APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    let raw = await res.text();
    let json;
    try { json = JSON.parse(raw); } catch(e) { throw new Error('JSON parse error: '+e+' / raw='+raw); }
    if (!json.ok) throw new Error(json.error || '投稿失敗');

    // 反映（ID付き）
    const nowIso = new Date().toISOString();
    addMarker({
      id: json.id,
      timestamp: nowIso,
      lat: pos.lat, lng: pos.lng, comment, avatarUrl,
      startAt: payload.startAt, endAt: payload.endAt,
      userId, currentUserId: userId
    });
    commentEl.value = '';
    setStatus('投稿しました');
  } catch (e1) {
    console.warn('POST (json) failed, fallback to text/plain:', e1);
    try {
      let res = await fetch(CONFIG.APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });
      let raw = await res.text();
      let json;
      try { json = JSON.parse(raw); } catch(e) { throw new Error('JSON parse error: '+e+' / raw='+raw); }
      if (!json.ok) throw new Error(json.error || '投稿失敗');
      const nowIso = new Date().toISOString();
      addMarker({
        id: json.id,
        timestamp: nowIso,
        lat: pos.lat, lng: pos.lng, comment, avatarUrl,
        startAt: payload.startAt, endAt: payload.endAt,
        userId, currentUserId: userId
      });
      commentEl.value = '';
      setStatus('投稿しました');
    } catch (e2) {
      console.error('POST failed:', e2);
      alert('投稿に失敗しました。時間をおいて再度お試しください。');
      setStatus('投稿エラー');
    }
  }
}

// ---- 削除（本人／管理者のみ） ----
async function deletePost(id, ownerUserId){
  await ensureLiff();
  // 現在ログイン中ユーザー確認
  let currentUserId = 'guest';
  try {
    const profile = await liff.getProfile();
    if (profile && profile.userId) currentUserId = profile.userId;
  } catch(e) {}

  setStatus('削除中…');
  const payload = { action: 'delete', id, userId: currentUserId };

  try {
    let res = await fetch(CONFIG.APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    let raw = await res.text();
    let json;
    try { json = JSON.parse(raw); } catch(e) { throw new Error('JSON parse error: '+e+' / raw='+raw); }
    if (!json.ok) throw new Error(json.error || '削除失敗');

    // 地図から除去
    const mk = markersById.get(id);
    if (mk) { mk.setMap(null); markersById.delete(id); }
    setStatus('削除しました');
  } catch(e1){
    console.warn('DELETE json failed, fallback to text/plain:', e1);
    try {
      let res = await fetch(CONFIG.APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });
      let raw = await res.text();
      let json;
      try { json = JSON.parse(raw); } catch(e) { throw new Error('JSON parse error: '+e+' / raw='+raw); }
      if (!json.ok) throw new Error(json.error || '削除失敗');

      const mk = markersById.get(id);
      if (mk) { mk.setMap(null); markersById.delete(id); }
      setStatus('削除しました');
    } catch(e2){
      console.error('DELETE failed:', e2);
      alert('削除に失敗しました。時間をおいて再度お試しください。');
      setStatus('削除エラー');
    }
  }
}
</script>

<!-- Google Maps API -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA4oFb8iNj2R_2lzlvpSZgOZiets5j2psg&callback=initMap"></script>
</body>
</html>
