
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>イベントマップ＋コメント投稿</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; margin: 10px; color: #333; }
  h1 { font-size: 1.8em; color: #2e7d32; text-align: center; }
  #map { width: 100%; height: 300px; margin-top: 20px; border-radius: 8px; }
  #post-panel { margin-top: 12px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:10px; }
  textarea { width: 100%; min-height: 60px; font-size: 14px; }
  button { padding: 12px 20px; margin: 5px; background-color: #2e7d32; color: white; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; }
  button:hover { background-color: #1b5e20; }
  #status { color:#666; margin-left:6px; font-size: 0.9em; }
</style>
</head>
<body>

<h1>ShiomiX イベントマップ</h1>
<div id="map"></div>

<!-- コメント投稿 -->
<div id="post-panel">
  <p>現在地（または地図中心）を使ってコメントを投稿します。</p>
  <textarea id="comment" placeholder="例：混雑少なめ／イベント開始まで10分"></textarea>
  <div>
    <button id="postBtn">コメントを投稿</button>
    <span id="status"></span>
  </div>
</div>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<script>
const CONFIG = {
  LIFF_ID: "2008298139-lwyMjbwP", // ご提供のLIFF ID
  APPS_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbwuLDoaxlono89h-qZbWf4k7Q5OMLwSeKO9zwFCZ6Bjds9ko_SSuRxydNBf8USWkgc/exec", // ご提供のApps Script URL
  TTL_HOURS_TO_LOAD: 24
};

let map;

// HTMLエスケープ
const esc = s => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

(async function initLiff(){
  await liff.init({ liffId: CONFIG.LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();
})();

async function initMap() {
  const center = { lat: 35.659466436461635, lng: 139.8171347921082 }; // 潮見高架下
  map = new google.maps.Map(document.getElementById("map"), { zoom: 18, center });
  new google.maps.Marker({ position: center, map, title: "潮見高架下" });
  await loadPosts();
}

function setStatus(msg){ document.getElementById('status').textContent = msg || ''; }

async function getCurrentLatLng(){
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) return reject();
    navigator.geolocation.getCurrentPosition(
      p => resolve({ lat: p.coords.latitude, lng: p.coords.longitude }),
      () => reject(),
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });
}

async function loadPosts(){
  setStatus('読み込み中…');
  try {
    const res = await fetch(`${CONFIG.APPS_SCRIPT_URL}?ttlHours=${CONFIG.TTL_HOURS_TO_LOAD}`);
    const json = await res.json();
    if (!json.ok) throw new Error(json.error);
    json.data.forEach(addMarker);
    setStatus(`読み込み完了（${json.data.length}件）`);
  } catch (e) {
    setStatus('読み込み失敗');
  }
}

function addMarker(p){
  const marker = new google.maps.Marker({ position: { lat: p.lat, lng: p.lng }, map });
  const info = new google.maps.InfoWindow({ content: `<div><b>${esc(p.comment)}</b><br>${new Date(p.timestamp).toLocaleString()}</div>` });
  marker.addListener('click', () => info.open({ anchor: marker, map }));
}

document.getElementById('postBtn').addEventListener('click', async () => {
  const comment = document.getElementById('comment').value.trim();
  if (!comment) return alert('コメントを入力してください');
  setStatus('投稿中…');
  try {
    const profile = await liff.getProfile();
    const pos = await getCurrentLatLng().catch(() => map.getCenter().toJSON());
    const payload = { userId: profile.userId, lat: pos.lat, lng: pos.lng, comment };
    const res = await fetch(CONFIG.APPS_SCRIPT_URL, {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
    });
    const json = await res.json();
    if (!json.ok) throw new Error(json.error);
    addMarker({ timestamp: new Date().toISOString(), lat: pos.lat, lng: pos.lng, comment });
    document.getElementById('comment').value = '';
    setStatus('投稿しました');
  } catch (e) {
    setStatus('投稿エラー');
    alert('投稿に失敗しました');
  }
});
</script>

<!-- Google Maps API（APIキー組み込み済み） -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA4oFb8iNj2R_2lzlvpSZgOZiets5j2psg&callback=initMap"></script>
</body>
</html>
