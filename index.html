
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ShiomiXマップ（コメント投稿対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; margin: 10px; color: #333; }
    h1 { font-size: 1.8em; color: #2e7d32; text-align: center; }
    /* 縦を2倍に */
    #map { width: 100%; height: 600px; margin-top: 20px; border-radius: 8px; }

    #post-panel { margin-top: 12px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:10px; }
    textarea { width: 100%; min-height: 60px; font-size: 14px; }
    button { padding: 10px 16px; margin: 5px; background-color: #2e7d32; color: white; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; }
    button:hover { background-color: #1b5e20; }
    #status { color:#666; margin-left:6px; font-size: 0.9em; }
    .small { font-size: 12px; color:#777; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

    /* カラー選択のラジオボタン（見た目重視） */
    .color-swatch { display:inline-flex; align-items:center; gap:6px; margin-right:10px; cursor:pointer; }
    .swatch {
      width: 18px; height: 18px; border-radius: 50%;
      border: 1px solid #bbb; display:inline-block;
    }
    .danger { background:#c62828; }
    .danger:hover { background:#8e0000; }
  </style>
</head>
<body>

<h1>ShiomiXマップ</h1>
<div id="map"></div>

<!-- コメント投稿 -->
<div id="post-panel">
  <p>現在地（または地図中心）を使ってコメントを投稿します。</p>

  <textarea id="comment" placeholder="例：混雑少なめ／イベント開始まで10分"></textarea>

  <!-- 色選択（枠なし・淡色） -->
  <div class="row" aria-label="吹き出し色の選択">
    <span class="small">色：</span>
    <label class="color-swatch">
      <input type="radio" name="bubbleColor" value="pink" checked>
      <span class="swatch" style="background:#ffd1dc"></span>ピンク
    </label>
    <label class="color-swatch">
      <input type="radio" name="bubbleColor" value="green">
      <span class="swatch" style="background:#d7f5d1"></span>薄緑
    </label>
    <label class="color-swatch">
      <input type="radio" name="bubbleColor" value="blue">
      <span class="swatch" style="background:#d7efff"></span>水色
    </label>
    <label class="color-swatch">
      <input type="radio" name="bubbleColor" value="yellow">
      <span class="swatch" style="background:#fff2c6"></span>黄色
    </label>
    <label class="color-swatch">
      <input type="radio" name="bubbleColor" value="gray">
      <span class="swatch" style="background:#e6e6e6"></span>グレー
    </label>
  </div>

  <!-- 表示時間プリセット -->
  <div class="row">
    <label for="duration">表示時間：</label>
    <select id="duration">
      <option value="1">1時間</option>
      <option value="3">3時間</option>
      <option value="6">6時間</option>
      <option value="12">12時間</option>
      <option value="24">24時間</option>
    </select>
  </div>

  <div class="row">
    <button id="postBtn">コメントを投稿</button>
    <span id="status"></span>
  </div>
  <p class="small">※位置が取得できない場合は地図中心座標で投稿します。</p>
</div>

<!-- LIFF SDK（正しいscriptタグ） -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<script>
/** 設定 **/
const CONFIG = {
  LIFF_ID: "2008298139-lwyMjbwP",
  APPS_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbyFIrGTYWNhTw7I0u5zK-uPDrzGxH_7xXUxbS-ptxoWBWJTPeE-lu6QLSN5jt35xSc/exec",
  TTL_HOURS_TO_LOAD: 24
};

let map;
const markersById = new Map(); // id -> marker

// 淡色カラーマップ（枠なし）
const BUBBLE_COLORS = {
  pink:   '#ffd1dc',
  green:  '#d7f5d1',
  blue:   '#d7efff',
  yellow: '#fff2c6',
  gray:   '#e6e6e6'
};

// HTMLエスケープ
const esc = s => String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

// ---- LIFF初期化 ----
let liffReady = (async function(){
  try {
    await liff.init({ liffId: CONFIG.LIFF_ID });
    if (!liff.isLoggedIn()) liff.login();
  } catch (e) {
    console.warn('LIFF init error:', e);
  }
})();
async function ensureLiff(){ try { await liffReady; } catch(e) {} }

// ---- 地図初期化（起動時に現在地へセンタリング） ----
async function initMap() {
  const fallback = { lat: 35.659466436461635, lng: 139.8171347921082 }; // 潮見高架下
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 18,
    center: fallback
  });

  try {
    const me = await getCurrentLatLng();
    map.setCenter(me);
    // 現在地の青ドット
    new google.maps.Marker({
      position: me,
      map,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: '#4285F4',
        fillOpacity: 0.9,
        strokeColor: '#ffffff',
        strokeWeight: 2,
        scale: 8
      },
      title: '現在地'
    });
  } catch(e) {
    // 位置取得失敗時はフォールバック中心のまま
    console.warn('current position not available:', e);
  }

  await loadPosts();
}

function setStatus(msg){ document.getElementById('status').textContent = msg || ''; }

// 位置取得（失敗時は地図中心）
async function getCurrentLatLng(){
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) return reject(new Error('no geolocation'));
